name: Run

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦æ¯”è¼ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

      - name: åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º
        run: |
          echo è‰ã¯ç”Ÿã‚„ã™ç‰©
          echo å¤šåˆ†
          date

      - name: æ›´æ–°ã•ã‚ŒãŸéƒ¨åˆ†ã‚’è¡¨ç¤ºï¼ˆãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼‰
        if: github.event_name == 'push'
        run: |
          echo "ğŸ” æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          git diff --name-status ${{ github.event.before }} ${{ github.event.after }}

          echo "ğŸ“ å¤‰æ›´å†…å®¹ã®è©³ç´°:"
          git diff --stat ${{ github.event.before }} ${{ github.event.after }}

          echo "ğŸ“„ å¤‰æ›´å†…å®¹ï¼ˆæœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰:"
          git diff --unified=1 ${{ github.event.before }} ${{ github.event.after }} | head -n 300

      - name: æ—¥è¨˜.mdã®æ›´æ–°å†…å®¹ã‚’ç‰¹åˆ¥ã«è¡¨ç¤ºï¼ˆãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼‰
        if: github.event_name == 'push'
        run: |
          # æ—¥è¨˜.mdãŒæ›´æ–°ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
          if git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep -q "æ—¥è¨˜.md"; then
            echo "ğŸ“” æ—¥è¨˜.mdãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"

            # æ›´æ–°å¾Œã®æ—¥è¨˜.mdã‚’å–å¾—
            git show ${{ github.event.after }}:æ—¥è¨˜.md > diary_current.txt

            # å¤‰æ›´å†…å®¹ã‚’å–å¾—
            git diff ${{ github.event.before }} ${{ github.event.after }} æ—¥è¨˜.md > diff_output.txt

            # è¿½åŠ ã•ã‚ŒãŸæ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®š
            ADDED_DATES=$(grep -E "^\+## [0-9]{4}-[0-9]{2}-[0-9]{2}" diff_output.txt | sed 's/^\+## //' | cut -d' ' -f1 | sort -r)

            # å¤‰æ›´ã•ã‚ŒãŸè¡Œã‚’å«ã‚€æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®š
            CHANGED_SECTIONS=$(grep -E "^@@ .* @@ ## [0-9]{4}-[0-9]{2}-[0-9]{2}" diff_output.txt | sed -E 's/^@@ .* @@ ## ([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/' | sort -r | uniq)

            # ä¸¡æ–¹ã‚’ãƒãƒ¼ã‚¸ã—ã¦é‡è¤‡ã‚’å‰Šé™¤
            ALL_DATES=$(echo "$ADDED_DATES $CHANGED_SECTIONS" | tr ' ' '\n' | sort -r | uniq)

            if [ -n "$ALL_DATES" ]; then
              echo "ğŸ“… æ›´æ–°ã•ã‚ŒãŸæ—¥ä»˜: $ALL_DATES"

              # å„æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†
              for DATE in $ALL_DATES; do
                if [ -z "$DATE" ]; then
                  continue
                fi

                echo ""
                echo "## $DATE ã®æ—¥è¨˜å†…å®¹:"

                # æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹è¡Œã¨çµ‚äº†è¡Œã‚’å–å¾—
                START_LINE=$(grep -n "^## $DATE" diary_current.txt | head -1 | cut -d: -f1)

                if [ -n "$START_LINE" ]; then
                  # æ¬¡ã®æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚’æŠ½å‡º
                  NEXT_LINE=$(tail -n +$((START_LINE + 1)) diary_current.txt | grep -n "^## " | head -1 | cut -d: -f1)

                  if [ -n "$NEXT_LINE" ]; then
                    END_LINE=$((START_LINE + NEXT_LINE - 1))
                    # æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’æŠ½å‡º
                    sed -n "${START_LINE},${END_LINE}p" diary_current.txt > section_content.txt
                  else
                    # æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«çµ‚ç«¯ã¾ã§
                    sed -n "${START_LINE},\$p" diary_current.txt > section_content.txt
                  fi

                  # detailsã‚¿ã‚°å†…ã®å†…å®¹ã‚’é™¤å¤–ã—ã¦è¡¨ç¤º
                  cat section_content.txt | awk '
                    BEGIN { in_details = 0; }
                    /^<details>/ { in_details = 1; next; }
                    /^<\/details>/ { in_details = 0; next; }
                    /^<summary>/ { next; }
                    { if (!in_details) print; }
                  '

                  # è¿½åŠ ã•ã‚ŒãŸè¡Œã‚’ã€Œ+ã€ä»˜ãã§è¡¨ç¤º
                  echo ""
                  echo "ğŸ“ è¿½åŠ ã•ã‚ŒãŸå†…å®¹ï¼ˆ+ä»˜ãï¼‰:"

                  # æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®è¿½åŠ ã•ã‚ŒãŸè¡Œã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º
                  ADDED_LINES=$(grep -A 1000 "^@@ .* @@ ## $DATE" diff_output.txt |
                    grep -B 1000 -m 1 "^@@ " |
                    grep "^\+" |
                    grep -v "^+## " |
                    grep -v "^+++" |
                    grep -v "^+@@ " |
                    sed 's/^\+/+ /' |
                    grep -v "+ <details>" |
                    grep -v "+ </details>" |
                    grep -v "+ <summary>" |
                    grep -v "+ \`\`\`")

                  if [ -n "$ADDED_LINES" ]; then
                    echo "$ADDED_LINES"
                  else
                    echo "(è¿½åŠ ã•ã‚ŒãŸå†…å®¹ã¯ã‚ã‚Šã¾ã›ã‚“)"
                  fi
                fi
              done
            else
              echo "æ—¥è¨˜.mdãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸãŒã€æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"

              # å¤‰æ›´ã•ã‚ŒãŸè¡Œã‚’è¡¨ç¤ºï¼ˆdetailsã‚¿ã‚°å†…ã¯é™¤å¤–ï¼‰
              echo ""
              echo "ğŸ“ æ›´æ–°ã•ã‚ŒãŸå†…å®¹ï¼ˆ+ä»˜ãï¼‰:"
              ADDED_LINES=$(grep "^\+" diff_output.txt |
                grep -v "^+++" |
                grep -v "^+@@ " |
                sed 's/^\+/+ /' |
                grep -v "+ <details>" |
                grep -v "+ </details>" |
                grep -v "+ <summary>" |
                grep -v "+ \`\`\`")

              if [ -n "$ADDED_LINES" ]; then
                echo "$ADDED_LINES"
              else
                echo "(è¿½åŠ ã•ã‚ŒãŸå†…å®¹ã¯ã‚ã‚Šã¾ã›ã‚“)"
              fi
            fi

            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            rm -f diary_current.txt diff_output.txt section_content.txt
          fi
