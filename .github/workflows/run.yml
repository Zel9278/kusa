name: Run

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦æ¯”è¼ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

      - name: åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º
        run: |
          echo è‰ã¯ç”Ÿã‚„ã™ç‰©
          echo å¤šåˆ†
          date

      - name: æ›´æ–°ã•ã‚ŒãŸéƒ¨åˆ†ã‚’è¡¨ç¤ºï¼ˆãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼‰
        if: github.event_name == 'push'
        run: |
          echo "ğŸ” æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          git diff --name-status ${{ github.event.before }} ${{ github.event.after }}

          echo "ğŸ“ å¤‰æ›´å†…å®¹ã®è©³ç´°:"
          git diff --stat ${{ github.event.before }} ${{ github.event.after }}

          echo "ğŸ“„ å¤‰æ›´å†…å®¹ï¼ˆæœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰:"
          git diff --unified=1 ${{ github.event.before }} ${{ github.event.after }} | head -n 300

      - name: æ—¥è¨˜.mdã®æ›´æ–°å†…å®¹ã‚’ç‰¹åˆ¥ã«è¡¨ç¤ºï¼ˆãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼‰
        if: github.event_name == 'push'
        run: |
          # æ—¥è¨˜.mdãŒæ›´æ–°ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
          if git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep -q "æ—¥è¨˜.md"; then
            echo "ğŸ“” æ—¥è¨˜.mdãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"

            # å¤‰æ›´ã•ã‚ŒãŸæ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®š
            CHANGED_DATES=$(git diff ${{ github.event.before }} ${{ github.event.after }} æ—¥è¨˜.md | grep -E "^\+## [0-9]{4}-[0-9]{2}-[0-9]{2}" | sed 's/^+## //' | sort -r)

            if [ -n "$CHANGED_DATES" ]; then
              echo "ğŸ“… æ›´æ–°ã•ã‚ŒãŸæ—¥ä»˜: $CHANGED_DATES"

              # å„æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’è¡¨ç¤º
              for DATE in $CHANGED_DATES; do
                echo ""
                echo "## $DATE ã®æ—¥è¨˜å†…å®¹:"

                # æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹è¡Œã¨çµ‚äº†è¡Œã‚’å–å¾—
                START_LINE=$(grep -n "^## $DATE" æ—¥è¨˜.md | cut -d: -f1)

                if [ -n "$START_LINE" ]; then
                  # æ¬¡ã®æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«çµ‚ç«¯ã¾ã§ã‚’å–å¾—
                  NEXT_DATE_LINE=$(tail -n +$((START_LINE + 1)) æ—¥è¨˜.md | grep -n "^##" | head -1 | cut -d: -f1)

                  if [ -n "$NEXT_DATE_LINE" ]; then
                    END_LINE=$((START_LINE + NEXT_DATE_LINE - 1))
                  else
                    # æ¬¡ã®æ—¥ä»˜ãŒãªã„å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«çµ‚ç«¯ã¾ã§
                    END_LINE=$(wc -l < æ—¥è¨˜.md)
                  fi

                  # æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’æŠ½å‡ºï¼ˆdetailsã‚¿ã‚°å†…ã¯é™¤å¤–ï¼‰
                  SECTION_CONTENT=$(sed -n "${START_LINE},${END_LINE}p" æ—¥è¨˜.md)

                  # detailsã‚¿ã‚°å†…ã®å†…å®¹ã‚’é™¤å¤–ã—ã¦è¡¨ç¤º
                  echo "$SECTION_CONTENT" | awk '
                    BEGIN { in_details = 0; print_line = 1; }
                    /^<details>/ { in_details = 1; print_line = 0; }
                    /^<\/details>/ { in_details = 0; print_line = 0; next; }
                    { if (print_line) print; }
                    { if (!in_details) print_line = 1; }
                  '

                  # è¿½åŠ ã•ã‚ŒãŸè¡Œã‚’ã€Œ+ã€ä»˜ãã§è¡¨ç¤º
                  echo ""
                  echo "ğŸ“ è¿½åŠ ã•ã‚ŒãŸå†…å®¹ï¼ˆ+ä»˜ãï¼‰:"
                  git diff ${{ github.event.before }} ${{ github.event.after }} æ—¥è¨˜.md | grep -A 100 "^## $DATE" | grep -B 100 -m 1 "^## " | grep "^\+" | grep -v "^+## " | sed 's/^\+/+ /' | grep -v "<details>" | grep -v "</details>" | grep -v "^+ <summary>" | grep -v "^+ \`\`\`" | grep -v "^+ $"
                fi
              done
            else
              echo "æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€æ—¢å­˜ã®æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã§æ›´æ–°ãŒã‚ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"

              # å¤‰æ›´ã•ã‚ŒãŸè¡Œã‚’è¡¨ç¤ºï¼ˆdetailsã‚¿ã‚°å†…ã¯é™¤å¤–ï¼‰
              echo ""
              echo "ğŸ“ æ›´æ–°ã•ã‚ŒãŸå†…å®¹ï¼ˆ+ä»˜ãï¼‰:"
              git diff ${{ github.event.before }} ${{ github.event.after }} æ—¥è¨˜.md | grep "^\+" | grep -v "^+++" | sed 's/^\+/+ /' | grep -v "<details>" | grep -v "</details>" | grep -v "^+ <summary>" | grep -v "^+ \`\`\`" | grep -v "^+ $"
            fi
          fi
